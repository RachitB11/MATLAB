I0  = imread('goldengate-03.png');
I1  = imread('goldengate-04.png');
display('ok0');
cimg0 = corner_detector(I0);
cimg1 = corner_detector(I1);
display('ok1');
[x0, y0, rmax0] = anms(cimg0, 100);
[x1, y1, rmax1] = anms(cimg1, 100);
display('ok2');
descs0 = feat_desc(I0, x0, y0);
descs1 = feat_desc(I1, x1, y1);
display('ok3');
[match] = feat_match(descs0, descs1);
display('ok3.5');
[ind,~,match_red] = find(match.*(match~=-1));
match_tab = [ind,match(ind)];
x0 = x0(match_tab(:,1));
x1 = x1(match_tab(:,2));
y0 = y0(match_tab(:,1));
y1 = y1(match_tab(:,2));
display('ok4');
[H, inlier_ind] = ransac_est_homography(x0, y0, x1, y1, 2);
display('ok5');
% visual_match( I0,I1,x0, y0, x1, y1, inlier_ind)
I1  = padarray(I1,[300,300]);
[h0, w0] = size(I0);
corn0 = [1,1;w0,1;w0,h0;1,h0;1,1];
[Xc, Yc] = apply_homography(inv(H),corn0(:,1),corn0(:,2));
corn1  = [round(Xc)+300,round(Yc)+300];
[h1, w1] = size(I1);
mask  = poly2mask(corn1(:,1),corn1(:,2),h1,w1);
x_coord = 1:w1;
y_coord = 1:h1;
[x,y] = meshgrid(x_coord,y_coord);
x_seg = nonzeros(mask.*x);
y_seg = nonzeros(mask.*y);
[X_seg, Y_seg] = apply_homography(H,x_seg(:)-300,y_seg(:)-300);
X_seg = min(max(X_seg,1),w0);
Y_seg = min(max(Y_seg,1),h0);
idx = sub2ind([h1,w1],y_seg,x_seg);
double(I1);
I1(idx) = interp2(double(I0),X_seg,Y_seg);
I1 = I1(:,1:end-300)
imshow(uint8(I1));
display('ok6');